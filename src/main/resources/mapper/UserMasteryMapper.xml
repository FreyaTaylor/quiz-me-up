<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.quizmeup.mapper.UserMasteryMapper">

    <!-- 根据用户ID和知识点ID查询掌握度 -->
    <select id="selectByUserIdAndKnowledgeId" resultType="com.example.quizmeup.entity.UserMastery">
        SELECT user_id,
               knowledge_id,
               proficiency,
               updated_at
        FROM lc_user_mastery
        WHERE user_id = #{userId}
          AND knowledge_id = #{knowledgeId}
    </select>

    <!-- 根据用户ID和知识点ID查询掌握度（加锁，用于并发更新） -->
    <select id="selectByUserIdAndKnowledgeIdForUpdate" resultType="com.example.quizmeup.entity.UserMastery">
        SELECT user_id,
               knowledge_id,
               proficiency,
               updated_at
        FROM lc_user_mastery
        WHERE user_id = #{userId}
          AND knowledge_id = #{knowledgeId}
        FOR UPDATE
    </select>

    <!-- 插入用户掌握度记录（如果已存在则更新） -->
    <insert id="insert" parameterType="com.example.quizmeup.entity.UserMastery">
        INSERT INTO lc_user_mastery (user_id, knowledge_id, proficiency, updated_at)
        VALUES (#{userId}, #{knowledgeId}, #{proficiency}, #{updatedAt})
        ON DUPLICATE KEY UPDATE
            proficiency = #{proficiency},
            updated_at = #{updatedAt}
    </insert>

    <!-- 更新用户掌握度 -->
    <update id="updateProficiency" parameterType="com.example.quizmeup.entity.UserMastery">
        UPDATE lc_user_mastery
        SET proficiency = #{proficiency},
            updated_at = #{updatedAt}
        WHERE user_id = #{userId}
          AND knowledge_id = #{knowledgeId}
    </update>

</mapper>
