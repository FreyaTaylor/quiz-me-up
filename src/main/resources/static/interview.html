<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIé¢è¯•æ¨¡æ‹Ÿ - ç­”é¢˜é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .question-card {
            transition: all 0.3s ease;
        }
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .login-modal {
            display: none;
        }
        .login-modal.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="login-modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">ç”¨æˆ·ç™»å½•</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·åï¼š</label>
                    <input 
                        type="text" 
                        id="loginUsername" 
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                    />
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç ï¼š</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="è¯·è¾“å…¥å¯†ç "
                    />
                </div>
                <div class="flex space-x-4">
                    <button 
                        type="submit"
                        class="flex-1 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        ç™»å½•
                    </button>
                    <button 
                        type="button"
                        onclick="closeLoginModal()"
                        class="flex-1 px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        å–æ¶ˆ
                    </button>
                </div>
                <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
            </form>
        </div>
    </div>

    <!-- å¯¼èˆªæ  -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold">AIé¢è¯•æ¨¡æ‹Ÿå¹³å°</h1>
                <div class="flex items-center space-x-4">
                    <span id="userInfo" class="text-sm hidden">
                        <span id="usernameDisplay"></span>
                        <button onclick="logout()" class="ml-2 px-3 py-1 bg-red-500 rounded hover:bg-red-600 text-xs">é€€å‡º</button>
                    </span>
                    <a href="/interview.html" class="px-4 py-2 bg-blue-700 rounded hover:bg-blue-800">ç­”é¢˜</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- ä¸»é¢˜é€‰æ‹©åŒºåŸŸ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">é€‰æ‹©çŸ¥è¯†ç‚¹</h2>
            <div class="flex items-center space-x-4">
                <label class="text-gray-700 font-medium">ä¸»é¢˜ï¼š</label>
                <select id="topicSelect" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                    <option value="">è¯·å…ˆç™»å½•...</option>
                </select>
                <button id="generateBtn" onclick="generateQuestions()" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    åŠ è½½é¢˜ç›®
                </button>
            </div>
        </div>

        <!-- é¢˜ç›®åˆ—è¡¨åŒºåŸŸ -->
        <div id="questionsContainer" class="space-y-4">
            <div class="bg-white rounded-lg shadow-md p-6 text-center text-gray-500">
                è¯·å…ˆç™»å½•åé€‰æ‹©ä¸»é¢˜å¹¶ç‚¹å‡»"ç”Ÿæˆé¢˜ç›®"æŒ‰é’®
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        const TOKEN = 'local-dev-token';

        // ä» sessionStorage è·å–ç”¨æˆ·ä¿¡æ¯
        function getUserId() {
            return sessionStorage.getItem('userId');
        }

        function getUsername() {
            return sessionStorage.getItem('username');
        }

        function setUserInfo(userId, username) {
            sessionStorage.setItem('userId', userId);
            sessionStorage.setItem('username', username);
        }

        function clearUserInfo() {
            sessionStorage.removeItem('userId');
            sessionStorage.removeItem('username');
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLogin() {
            const userId = getUserId();
            const username = getUsername();
            
            if (userId && username) {
                // å·²ç™»å½•
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('usernameDisplay').textContent = `æ¬¢è¿ï¼Œ${username}`;
                document.getElementById('topicSelect').disabled = false;
                document.getElementById('generateBtn').disabled = false;
                loadTopics();
                return true;
            } else {
                // æœªç™»å½•
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('topicSelect').disabled = true;
                document.getElementById('generateBtn').disabled = true;
                showLoginModal();
                return false;
            }
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
        }

        // å…³é—­ç™»å½•æ¨¡æ€æ¡†
        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        // å¤„ç†ç™»å½•
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Token': TOKEN
                    },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                    }
                    throw new Error('ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }

                const result = await response.json();
                setUserInfo(result.userId.toString(), result.username);
                closeLoginModal();
                checkLogin();
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            clearUserInfo();
            checkLogin();
            // æ¸…ç©ºé¡µé¢å†…å®¹
            document.getElementById('questionsContainer').innerHTML = 
                '<div class="bg-white rounded-lg shadow-md p-6 text-center text-gray-500">è¯·å…ˆç™»å½•åé€‰æ‹©ä¸»é¢˜å¹¶ç‚¹å‡»"ç”Ÿæˆé¢˜ç›®"æŒ‰é’®</div>';
            document.getElementById('topicSelect').innerHTML = '<option value="">è¯·å…ˆç™»å½•...</option>';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„çŸ¥è¯†ç‚¹ï¼ˆä»å­¦ä¹ è®¡åˆ’è·³è½¬è¿‡æ¥ï¼‰
            const selectedKnowledgeId = sessionStorage.getItem('selectedKnowledgeId');
            if (selectedKnowledgeId) {
                sessionStorage.removeItem('selectedKnowledgeId');
                // ç­‰å¾…çŸ¥è¯†ç‚¹åˆ—è¡¨åŠ è½½å®Œæˆåè‡ªåŠ¨é€‰æ‹©
                setTimeout(() => {
                    const select = document.getElementById('topicSelect');
                    if (select) {
                        select.value = selectedKnowledgeId;
                        generateQuestions();
                    }
                }, 1000);
            }
        });

        // åŠ è½½çŸ¥è¯†ç‚¹åˆ—è¡¨ï¼ˆä½œä¸ºtopicé€‰æ‹©ï¼‰
        async function loadTopics() {
            const userId = getUserId();
            if (!userId) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/interview/topics?userId=${userId}`, {
                    headers: {
                        'X-Token': TOKEN
                    }
                });
                if (!response.ok) throw new Error('è·å–çŸ¥è¯†ç‚¹åˆ—è¡¨å¤±è´¥');
                
                const topics = await response.json();
                const select = document.getElementById('topicSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©çŸ¥è¯†ç‚¹...</option>';
                topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = `${topic.name} (å·²ç»ƒ ${topic.practicedCount || 0}/${topic.totalQuestions || 0} é¢˜)`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½çŸ¥è¯†ç‚¹å¤±è´¥:', error);
                alert('åŠ è½½çŸ¥è¯†ç‚¹åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // åŠ è½½é¢˜ç›®ï¼ˆæŒ‰çŸ¥è¯†ç‚¹ï¼‰
        async function generateQuestions() {
            const userId = getUserId();
            if (!userId) {
                alert('è¯·å…ˆç™»å½•');
                checkLogin();
                return;
            }

            const knowledgeId = document.getElementById('topicSelect').value;
            if (!knowledgeId) {
                alert('è¯·å…ˆé€‰æ‹©çŸ¥è¯†ç‚¹');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'åŠ è½½ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/interview/questions?userId=${userId}&knowledgeId=${knowledgeId}`, {
                    headers: {
                        'X-Token': TOKEN
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'åŠ è½½é¢˜ç›®å¤±è´¥');
                }

                const questions = await response.json();
                displayQuestions(questions);
            } catch (error) {
                console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
                alert('åŠ è½½é¢˜ç›®å¤±è´¥: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'åŠ è½½é¢˜ç›®';
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨
        function displayQuestions(questions) {
            const container = document.getElementById('questionsContainer');
            
            if (!questions || questions.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-lg shadow-md p-6 text-center text-gray-500">æš‚æ— é¢˜ç›®</div>';
                return;
            }

            container.innerHTML = questions.map((q, index) => `
                <div class="question-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                    é¢˜ç›® ${index + 1}
                                </span>
                                <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">
                                    ID: ${q.id}
                                </span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${escapeHtml(q.questionText)}</h3>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„ç­”æ¡ˆï¼š</label>
                        <textarea 
                            id="answer-${q.id}" 
                            rows="4" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ..."></textarea>
                    </div>
                    
                    <button 
                        onclick="submitAnswer('${q.id}')" 
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        æäº¤ç­”æ¡ˆ
                    </button>
                    
                    <div id="result-${q.id}" class="mt-4 hidden"></div>
                </div>
            `).join('');
        }

        // æäº¤ç­”æ¡ˆ
        async function submitAnswer(questionId) {
            const userId = getUserId();
            if (!userId) {
                alert('è¯·å…ˆç™»å½•');
                checkLogin();
                return;
            }

            const answerTextarea = document.getElementById(`answer-${questionId}`);
            const answer = answerTextarea.value.trim();
            
            if (!answer) {
                alert('è¯·è¾“å…¥ç­”æ¡ˆ');
                return;
            }

            const resultDiv = document.getElementById(`result-${questionId}`);
            resultDiv.innerHTML = '<div class="text-blue-600">è¯„åˆ†ä¸­...</div>';
            resultDiv.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/interview/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Token': TOKEN
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        questionId: questionId,
                        answer: answer
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'æäº¤ç­”æ¡ˆå¤±è´¥');
                }

                const result = await response.json();
                displayResult(questionId, result);
                // åˆ·æ–°çŸ¥è¯†ç‚¹åˆ—è¡¨ï¼ˆæ›´æ–°å·²ç­”é¢˜æ•°ï¼‰
                await loadTopics();
            } catch (error) {
                console.error('æäº¤ç­”æ¡ˆå¤±è´¥:', error);
                resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">æäº¤å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºè¯„åˆ†ç»“æœ
        function displayResult(questionId, result) {
            const resultDiv = document.getElementById(`result-${questionId}`);

            // å®‰å…¨è·å–å­—æ®µï¼Œæä¾›é»˜è®¤å€¼
            const score = typeof result.score === 'number' ? result.score : 0;
            const analysis = result.analysis || 'æš‚æ— åˆ†æ';
            const feedbackItems = Array.isArray(result.feedbackItems) ? result.feedbackItems : [];
            const recommendedAnswer = result.recommendedAnswer || 'ç³»ç»Ÿæš‚æœªç”Ÿæˆæ¨èå›ç­”';

            // æ ¹æ®åˆ†æ•°è®¾ç½®é¢œè‰²
            let scoreColor = 'bg-red-500';
            if (score >= 80) scoreColor = 'bg-green-500';
            else if (score >= 60) scoreColor = 'bg-yellow-500';

            // ç”Ÿæˆåé¦ˆè¡¨æ ¼HTML
            let tableHTML = '';
            if (feedbackItems.length > 0) {
                tableHTML = `
                    <div class="mt-4">
                        <div class="text-sm font-medium text-gray-700 mb-3">ğŸ“Š è¯„ä»·æ ‡å‡†åé¦ˆè¡¨æ ¼ï¼š</div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead>
                                    <tr class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white">
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">è¯„ä»·æ ‡å‡†</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider">æ˜¯å¦è¦†ç›–</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">ç”¨æˆ·å›ç­”</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${feedbackItems.map((item, index) => {
                                        const covered = item.covered === true;
                                        const userContent = item.userContent || '';

                                        return `
                                            <tr class="hover:bg-gray-50 transition-colors">
                                                <td class="px-4 py-3 text-sm font-medium text-gray-900">
                                                    ${index + 1}. ${escapeHtml(item.criterion || 'æœªçŸ¥æ ‡å‡†')}
                                                </td>
                                                <td class="px-4 py-3 text-sm text-center">
                                                    ${covered ? `
                                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                                            <span class="mr-1">âœ“</span> å·²è¦†ç›–
                                                        </span>
                                                    ` : `
                                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                                                            <span class="mr-1">âœ—</span> æœªè¦†ç›–
                                                        </span>
                                                    `}
                                                </td>
                                                <td class="px-4 py-3 text-sm text-gray-700">
                                                    ${userContent ? escapeHtml(userContent) : '<span class="text-gray-400 italic">æœªæ¶‰åŠ</span>'}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // æ¸²æŸ“å®Œæ•´ç»“æœ
            resultDiv.innerHTML = `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 space-y-4">
                    <!-- å¾—åˆ†åŒºåŸŸ -->
                    <div class="flex items-center space-x-4 pb-4 border-b border-gray-200">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-700">æ€»åˆ†ï¼š</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-16 h-16 rounded-full ${scoreColor} flex items-center justify-center text-white font-bold text-xl shadow-lg">
                                    ${score}
                                </div>
                                <span class="text-gray-600 font-medium">/ 100</span>
                            </div>
                        </div>
                    </div>

                    <!-- æ€»ä½“åˆ†æ -->
                    <div>
                        <div class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                            <span class="mr-2">ğŸ’¡</span> æ€»ä½“åˆ†æï¼š
                        </div>
                        <div class="bg-white rounded-lg p-4 text-gray-800 text-sm leading-relaxed border border-gray-200 whitespace-pre-wrap">
                            ${escapeHtml(analysis)}
                        </div>
                    </div>

                    <!-- åé¦ˆè¡¨æ ¼ -->
                    ${tableHTML}

                    <!-- æ¨èå›ç­” -->
                    <div>
                        <div class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                            <span class="mr-2">âœ¨</span> ç³»ç»Ÿæ¨èå›ç­”ï¼š
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 text-gray-800 text-sm leading-relaxed border border-blue-200 whitespace-pre-wrap">
                            ${escapeHtml(recommendedAnswer)}
                        </div>
                    </div>
                </div>
            `;
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
