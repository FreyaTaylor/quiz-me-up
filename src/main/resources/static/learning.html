<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习 - Quiz Me Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .text-gray-700, .text-gray-800 {
            color: #333 !important;
        }
        
        .content-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 24px;
        }
        
        .tab-item {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 8px;
            margin-right: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e3f2fd;
            color: #666;
            font-weight: 500;
        }
        
        .tab-item:hover {
            background-color: #f5f5f5;
        }
        
        .tab-item.active {
            background-color: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .tree-node {
            padding-left: 20px;
        }
        
        .tree-icon {
            display: inline-block;
            margin-right: 6px;
            color: #666;
            font-size: 10px;
        }
        
        .tree-leaf-icon {
            color: #1a73e8;
            font-size: 8px;
        }
        
        .star-icon {
            color: #FFD700;
            font-size: 12px;
            margin-right: 2px;
        }
        
        .start-learning-btn {
            width: 120px;
            height: 40px;
            background-color: #1a73e8;
            color: white;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .start-learning-btn:hover:not(:disabled) {
            background-color: #0d5cb6;
        }
        
        .start-learning-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        h1, h2, h3 {
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- 左侧：页面标题和导航 -->
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-gray-800">Quiz Me Up</h1>
                    <div class="flex space-x-2">
                        <a href="learning.html" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-100 text-blue-700">学习</a>
                        <a href="progress.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">进度</a>
                        <a id="adminLink" href="admin.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100" style="display: none;">管理</a>
                    </div>
                </div>
                
                <!-- 右侧：登录状态 -->
                <div class="flex items-center space-x-4">
                    <span id="userInfo" class="text-sm text-gray-600" style="display: none;"></span>
                    <button id="loginBtn" onclick="showLoginModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-700 text-white text-sm font-medium rounded-md focus:outline-none focus:shadow-outline">
                        登录
                    </button>
                    <button id="logoutBtn" onclick="handleLogout()" class="px-4 py-2 bg-gray-500 hover:bg-gray-700 text-white text-sm font-medium rounded-md focus:outline-none focus:shadow-outline" style="display: none;">
                        登出
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 登录模态框 -->
    <div id="loginModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">登录</h2>
                <button onclick="hideLoginModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="username">用户名</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                           id="username" type="text" placeholder="请输入用户名" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password">密码</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                           id="password" type="password" placeholder="请输入密码" required>
                </div>
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" 
                        type="submit">登录</button>
            </form>
        </div>
    </div>

    <!-- 学习内容 -->
    <div id="learningSection" class="max-w-4xl mx-auto mt-10 p-6">
        <div class="content-card mb-6">
            <h1 class="text-3xl font-bold mb-6" style="color: #333;">学习</h1>
            
            <!-- 一级知识点选择（Tabs风格） -->
            <div class="mb-6">
                <label class="block text-sm font-bold mb-3" style="color: #333;">选择知识领域</label>
                <div id="rootNodesContainer" class="flex flex-wrap">
                    <p class="text-gray-500">加载中...</p>
                </div>
            </div>
            
            <!-- 知识点选择（树状结构） -->
            <div class="mb-6" id="leafNodesSection" style="display: none;">
                <label class="block text-sm font-bold mb-3" style="color: #333;">选择知识点（仅叶节点可选）</label>
                <div id="knowledgeTree" class="border rounded-lg p-4 bg-gray-50 max-h-96 overflow-y-auto" style="border-color: #e0e0e0; border-radius: 8px;">
                    <p style="color: #666; text-align: center;">加载中...</p>
                </div>
                <input type="hidden" id="selectedKnowledgeId" value="">
            </div>
            <button onclick="startLearning()" class="start-learning-btn" id="startLearningBtn" style="display: none;">
                开始学习
            </button>
        </div>

        <!-- 题目列表 -->
        <div id="questionsListCard" class="content-card mb-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4" style="color: #333;">题目列表 (<span id="questionCount">0</span>)</h2>
            <div id="questionsList" class="space-y-6"></div>
        </div>
    </div>

    <script>
        console.log('脚本开始执行...');
        
        // 全局变量
        var userId = null;
        var username = null;
        
        // 全局变量：选中的根节点ID
        var selectedRootId = null;

        // 页面加载时检查登录状态
        window.onload = function() {
            console.log('window.onload 触发');
            checkLoginStatus();
        };
        
        // 如果 DOM 已经加载完成，立即执行
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            console.log('DOM 已就绪，立即执行');
            setTimeout(function() {
                checkLoginStatus();
            }, 100);
        }

        // 检查登录状态
        function checkLoginStatus() {
            console.log('checkLoginStatus 被调用');
            userId = sessionStorage.getItem('userId');
            username = sessionStorage.getItem('username');
            var userRole = sessionStorage.getItem('userRole');
            
            console.log('当前 userId:', userId);
            
            if (userId) {
                updateLoginUI(true);
                // 根据角色显示/隐藏管理页面链接
                var adminLink = document.getElementById('adminLink');
                if (adminLink) {
                    adminLink.style.display = (userRole === 'ADMIN') ? 'block' : 'none';
                }
                // 已登录，加载数据
                loadRootNodes();
            } else {
                updateLoginUI(false);
                var adminLink = document.getElementById('adminLink');
                if (adminLink) {
                    adminLink.style.display = 'none';
                }
                // 未登录，显示登录弹框
                showLoginModal();
                // 显示提示信息
                showLoginRequiredMessage();
            }
        }

        // 显示需要登录的提示信息
        function showLoginRequiredMessage() {
            var container = document.getElementById('rootNodesContainer');
            if (container) {
                container.innerHTML = '<div class="text-center p-4 bg-yellow-50 border border-yellow-200 rounded" style="border-radius: 8px;"><p style="color: #856404;">请先登录以使用所有功能</p></div>';
            }
        }

        // 统一的登录检查函数
        function requireLogin() {
            if (!userId) {
                alert('请先登录');
                showLoginModal();
                return false;
            }
            return true;
        }

        // 更新登录UI
        function updateLoginUI(isLoggedIn) {
            var loginBtn = document.getElementById('loginBtn');
            var logoutBtn = document.getElementById('logoutBtn');
            var userInfo = document.getElementById('userInfo');
            
            if (isLoggedIn) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                userInfo.style.display = 'block';
                userInfo.textContent = '用户: ' + (username || 'User ' + userId);
            } else {
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                userInfo.style.display = 'none';
            }
        }

        // 显示登录模态框
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        // 隐藏登录模态框
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            // 清空表单
            document.getElementById('loginForm').reset();
        }

        // 登录处理
        function handleLogin(event) {
            event.preventDefault();
            var usernameInput = document.getElementById('username').value;
            var password = document.getElementById('password').value;

            fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: usernameInput,
                    password: password
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.code === 200 && data.data) {
                    userId = data.data.userId.toString();
                    username = data.data.username || usernameInput;
                    var userRole = data.data.role || null;
                    sessionStorage.setItem('userId', userId);
                    sessionStorage.setItem('username', username);
                    sessionStorage.setItem('userRole', userRole);
                    
                    hideLoginModal();
                    updateLoginUI(true);
                    // 根据角色显示/隐藏管理页面链接
                    var adminLink = document.getElementById('adminLink');
                    if (adminLink) {
                        adminLink.style.display = (userRole === 'ADMIN') ? 'block' : 'none';
                    }
                    loadRootNodes();
                } else {
                    alert(data.message || '登录失败');
                }
            })
            .catch(function(error) {
                alert(error.message || '登录失败，请重试');
            });
        }

        // 全局变量：选中的根节点ID
        var selectedRootId = null;

        // 登出处理
        function handleLogout() {
            if (confirm('确定要登出吗？')) {
                sessionStorage.clear();
                // 重定向到登录页面
                window.location.href = 'login.html';
            }
        }

        // 加载一级知识点（根节点）
        function loadRootNodes() {
            if (!requireLogin()) {
                return;
            }
            
            console.log('开始加载一级知识点...');
            
            var url = '/api/v1/knowledge/root-nodes?userId=' + userId;
            var headers = {
                'Content-Type': 'application/json',
                'userId': userId
            };
            
            console.log('请求 URL:', url);
            
            fetch(url, {
                headers: headers
            })
            .then(function(response) {
                console.log('响应状态:', response.status);
                return response.json();
            })
            .then(function(data) {
                console.log('响应数据:', data);
                if (data.code === 200 && data.data) {
                    displayRootNodes(data.data);
                } else {
                    console.error('加载失败:', data.message);
                    var container = document.getElementById('rootNodesContainer');
                    if (container) {
                        container.innerHTML = '<p class="text-red-500 col-span-full">加载失败: ' + (data.message || '未知错误') + '</p>';
                    }
                }
            })
            .catch(function(error) {
                console.error('请求错误:', error);
                var container = document.getElementById('rootNodesContainer');
                if (container) {
                    container.innerHTML = '<p class="text-red-500 col-span-full">加载失败: ' + (error.message || '网络错误') + '</p>';
                }
            });
        }

        // 显示一级知识点矩形卡片
        function displayRootNodes(rootNodes) {
            console.log('显示一级知识点，数量:', rootNodes ? rootNodes.length : 0);
            
            var container = document.getElementById('rootNodesContainer');
            if (!container) {
                console.error('找不到 rootNodesContainer 元素');
                return;
            }
            
            container.innerHTML = '';
            
            if (!rootNodes || rootNodes.length === 0) {
                container.innerHTML = '<p style="color: #666;">暂无知识领域，请先在进度页面初始化知识点</p>';
                return;
            }
            
            rootNodes.forEach(function(node) {
                var tab = document.createElement('div');
                tab.className = 'tab-item';
                tab.dataset.rootId = node.id;
                tab.textContent = node.name;
                tab.onclick = function() {
                    selectRootNode(node.id, node.name);
                };
                
                container.appendChild(tab);
            });
            
            console.log('一级知识点卡片已渲染');
        }

        // 选中根节点
        function selectRootNode(rootId, rootName) {
            if (!requireLogin()) {
                return;
            }
            
            selectedRootId = rootId;
            
            // 更新 Tabs 选中状态
            var tabs = document.querySelectorAll('#rootNodesContainer > .tab-item');
            tabs.forEach(function(tab) {
                if (tab.dataset.rootId === rootId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // 加载该根节点下的叶节点
            loadLeafNodesByRoot(rootId);
            
            // 显示叶节点选择区域
            document.getElementById('leafNodesSection').style.display = 'block';
            document.getElementById('startLearningBtn').style.display = 'block';
        }

        // 全局变量：选中的知识点ID
        var selectedKnowledgeId = null;

        // 根据根节点ID加载知识树（只加载该根节点下的叶节点）
        function loadLeafNodesByRoot(rootId) {
            if (!rootId) {
                return;
            }
            
            if (!requireLogin()) {
                return;
            }
            
            console.log('加载知识树，rootId:', rootId);
            
            // 调用按根节点筛选的接口，返回该根节点下的树形结构
            fetch('/api/v1/knowledge/leaf-nodes-by-root?userId=' + userId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'userId': userId
                },
                body: JSON.stringify({
                    rootId: rootId,
                    userId: parseInt(userId)
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log('知识树响应:', data);
                if (data.code === 200 && data.data) {
                    var rootTree = data.data;
                    displayKnowledgeTree(rootTree);
                } else {
                    alert(data.message || '加载知识树失败');
                }
            })
            .catch(function(error) {
                console.error('加载知识树失败:', error);
                alert(error.message || '加载知识树失败');
            });
        }

        // 显示知识树（树状结构，只有叶节点可选）
        function displayKnowledgeTree(rootNode) {
            var container = document.getElementById('knowledgeTree');
            container.innerHTML = '';
            
            // 递归渲染树节点
            function renderTreeNode(node, parentElement, level) {
                level = level || 0;
                
                var nodeDiv = document.createElement('div');
                nodeDiv.className = 'mb-1 tree-node';
                if (level > 0) {
                    nodeDiv.style.paddingLeft = (level * 20) + 'px';
                }
                
                if (node.isLeaf) {
                    // 叶节点：可点击选择
                    nodeDiv.className += ' cursor-pointer hover:bg-blue-50 p-2 rounded';
                    nodeDiv.setAttribute('data-knowledge-id', node.id);
                    nodeDiv.onclick = function(e) {
                        e.stopPropagation();
                        selectKnowledgeNode(node.id, node.name);
                    };
                    
                    var leafContent = document.createElement('div');
                    leafContent.className = 'flex items-center gap-2';
                    
                    // 单选按钮样式
                    var radio = document.createElement('span');
                    radio.className = 'inline-block w-4 h-4 rounded-full border-2 flex-shrink-0 ' + 
                        (selectedKnowledgeId === node.id ? 'bg-blue-500 border-blue-500' : 'border-gray-300');
                    if (selectedKnowledgeId === node.id) {
                        radio.innerHTML = '<span class="block w-2 h-2 bg-white rounded-full mx-auto mt-0.5"></span>';
                    }
                    
                    // 节点名称
                    var nameSpan = document.createElement('span');
                    nameSpan.className = selectedKnowledgeId === node.id ? 'font-bold text-blue-600' : '';
                    nameSpan.style.color = selectedKnowledgeId === node.id ? '#1a73e8' : '#333';
                    nameSpan.textContent = node.name;
                    
                    // 星星（重要程度）- 统一为★，金色，区分度更大
                    var starsDiv = document.createElement('div');
                    starsDiv.className = 'flex items-center';
                    starsDiv.style.gap = '6px';
                    starsDiv.style.marginLeft = '8px';
                    var importance = node.importance || 3;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.createElement('span');
                        star.className = 'star-icon';
                        star.textContent = '★';
                        if (i <= importance) {
                            star.style.color = '#FFD700'; // 金色
                            star.style.opacity = '1';
                        } else {
                            star.style.color = '#d1d5db'; // 灰色
                            star.style.opacity = '0.2'; // 更透明，区分度更大
                        }
                        starsDiv.appendChild(star);
                    }
                    
                    // 小圆环（熟练程度）
                    var proficiencyRing = document.createElement('div');
                    proficiencyRing.className = 'ml-auto flex-shrink-0';
                    var proficiency = node.proficiency ? parseFloat(node.proficiency) : 0;
                    var ringSize = 24;
                    var strokeWidth = 3;
                    var radius = (ringSize - strokeWidth) / 2;
                    var circumference = 2 * Math.PI * radius;
                    var offset = circumference - (proficiency / 100) * circumference;
                    
                    var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('width', ringSize);
                    svg.setAttribute('height', ringSize);
                    svg.setAttribute('class', 'transform -rotate-90');
                    
                    // 背景圆环
                    var bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    bgCircle.setAttribute('cx', ringSize / 2);
                    bgCircle.setAttribute('cy', ringSize / 2);
                    bgCircle.setAttribute('r', radius);
                    bgCircle.setAttribute('fill', 'none');
                    bgCircle.setAttribute('stroke', '#e5e7eb');
                    bgCircle.setAttribute('stroke-width', strokeWidth);
                    
                    // 进度圆环
                    var progressCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    progressCircle.setAttribute('cx', ringSize / 2);
                    progressCircle.setAttribute('cy', ringSize / 2);
                    progressCircle.setAttribute('r', radius);
                    progressCircle.setAttribute('fill', 'none');
                    progressCircle.setAttribute('stroke', proficiency >= 80 ? '#10b981' : proficiency >= 60 ? '#3b82f6' : proficiency >= 40 ? '#f59e0b' : '#ef4444');
                    progressCircle.setAttribute('stroke-width', strokeWidth);
                    progressCircle.setAttribute('stroke-dasharray', circumference);
                    progressCircle.setAttribute('stroke-dashoffset', offset);
                    progressCircle.setAttribute('stroke-linecap', 'round');
                    progressCircle.style.transition = 'stroke-dashoffset 0.3s';
                    
                    svg.appendChild(bgCircle);
                    svg.appendChild(progressCircle);
                    proficiencyRing.appendChild(svg);
                    
                    leafContent.appendChild(radio);
                    leafContent.appendChild(nameSpan);
                    leafContent.appendChild(starsDiv);
                    leafContent.appendChild(proficiencyRing);
                    nodeDiv.appendChild(leafContent);
                } else {
                    // 非叶节点：可展开/折叠
                    var details = document.createElement('details');
                    details.className = 'cursor-pointer';
                    details.open = level < 1; // 默认只展开到第二级（level 0 和 1）
                    
                    var summary = document.createElement('summary');
                    summary.className = 'font-semibold p-1 flex items-center gap-2';
                    summary.style.color = '#333';
                    
                    // 节点图标
                    var nodeIcon = document.createElement('span');
                    nodeIcon.className = 'tree-icon';
                    nodeIcon.textContent = '▶';
                    
                    // 节点名称
                    var nameSpan = document.createElement('span');
                    nameSpan.textContent = node.name;
                    
                    // 星星（重要程度）- 统一为★，金色，区分度更大
                    var starsDiv = document.createElement('div');
                    starsDiv.className = 'flex items-center';
                    starsDiv.style.gap = '6px';
                    starsDiv.style.marginLeft = '8px';
                    var importance = node.importance || 3;
                    for (var i = 1; i <= 5; i++) {
                        var star = document.createElement('span');
                        star.className = 'star-icon';
                        star.textContent = '★';
                        if (i <= importance) {
                            star.style.color = '#FFD700'; // 金色
                            star.style.opacity = '1';
                        } else {
                            star.style.color = '#d1d5db'; // 灰色
                            star.style.opacity = '0.2'; // 更透明，区分度更大
                        }
                        starsDiv.appendChild(star);
                    }
                    
                    summary.appendChild(nodeIcon);
                    summary.appendChild(nameSpan);
                    summary.appendChild(starsDiv);
                    
                    details.appendChild(summary);
                    
                    // 子节点容器
                    var childrenDiv = document.createElement('div');
                    childrenDiv.className = 'ml-4 mt-1';
                    
                    if (node.children && node.children.length > 0) {
                        node.children.forEach(function(child) {
                            renderTreeNode(child, childrenDiv, level + 1);
                        });
                    }
                    
                    details.appendChild(childrenDiv);
                    nodeDiv.appendChild(details);
                }
                
                parentElement.appendChild(nodeDiv);
            }
            
            // 从第二级（根节点的children）开始渲染
            if (rootNode && rootNode.children && rootNode.children.length > 0) {
                rootNode.children.forEach(function(child) {
                    renderTreeNode(child, container, 0);
                });
            } else {
                container.innerHTML = '<p style="color: #666;">该知识领域下暂无子节点</p>';
            }
        }

        // 选择知识点（只有叶节点）
        function selectKnowledgeNode(knowledgeId, knowledgeName) {
            if (!requireLogin()) {
                return;
            }
            
            selectedKnowledgeId = knowledgeId;
            document.getElementById('selectedKnowledgeId').value = knowledgeId;
            
            // 更新所有单选按钮的样式
            var allNodes = document.querySelectorAll('#knowledgeTree [data-knowledge-id]');
            allNodes.forEach(function(node) {
                var nodeId = node.getAttribute('data-knowledge-id');
                var leafContent = node.querySelector('div.flex');
                if (!leafContent) return;
                
                // 获取元素：图标、单选按钮、名称
                var children = leafContent.children;
                var radio = null;
                var nameSpan = null;
                for (var i = 0; i < children.length; i++) {
                    var child = children[i];
                    if (child.classList.contains('inline-block') && child.classList.contains('rounded-full')) {
                        radio = child;
                    } else if (child.tagName === 'SPAN' && !child.classList.contains('tree-icon') && !child.classList.contains('flex')) {
                        nameSpan = child;
                    }
                }
                
                if (nodeId === knowledgeId) {
                    if (radio) {
                        radio.className = 'inline-block w-4 h-4 rounded-full border-2 flex-shrink-0 bg-blue-500 border-blue-500';
                        radio.innerHTML = '<span class="block w-2 h-2 bg-white rounded-full mx-auto mt-0.5"></span>';
                    }
                    if (nameSpan) {
                        nameSpan.className = 'font-bold';
                        nameSpan.style.color = '#1a73e8';
                    }
                    node.className = 'mb-1 cursor-pointer hover:bg-blue-50 p-2 rounded bg-blue-50 tree-node';
                } else {
                    if (radio) {
                        radio.className = 'inline-block w-4 h-4 rounded-full border-2 flex-shrink-0 border-gray-300';
                        radio.innerHTML = '';
                    }
                    if (nameSpan) {
                        nameSpan.className = '';
                        nameSpan.style.color = '#333';
                    }
                    node.className = 'mb-1 cursor-pointer hover:bg-blue-50 p-2 rounded tree-node';
                }
            });
            
            console.log('已选择知识点:', knowledgeId, knowledgeName);
        }

        // 开始学习
        function startLearning() {
            if (!requireLogin()) {
                return;
            }
            
            var knowledgeId = selectedKnowledgeId || document.getElementById('selectedKnowledgeId').value;
            if (!knowledgeId) {
                alert('请先选择知识点（仅叶节点可选）');
                return;
            }

            // 更新按钮状态
            var startBtn = document.getElementById('startLearningBtn');
            if (!startBtn) return;
            var originalText = startBtn.textContent;
            startBtn.disabled = true;
            startBtn.textContent = '加载中...';

            fetch('/api/v1/learning/start?userId=' + userId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'userId': userId
                },
                body: JSON.stringify({
                    userId: parseInt(userId),
                    knowledgeId: knowledgeId
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.code === 200 && data.data) {
                    var questions = data.data;
                    if (!questions || questions.length === 0) {
                        alert('该知识点下暂无题目');
                        startBtn.disabled = false;
                        startBtn.textContent = originalText;
                        return;
                    }
                    
                    // 显示题目列表
                    displayQuestionsList(questions);
                    startBtn.disabled = false;
                    startBtn.textContent = originalText;
                } else {
                    alert(data.message || '获取题目失败');
                    startBtn.disabled = false;
                    startBtn.textContent = originalText;
                }
            })
            .catch(function(error) {
                alert(error.message || '获取题目失败');
                startBtn.disabled = false;
                startBtn.textContent = originalText;
            });
        }

        // 显示题目列表（每个题目包含答题区域）
        function displayQuestionsList(questions) {
            // 确保 questions 是数组
            if (!Array.isArray(questions)) {
                console.error('题目数据格式错误:', questions);
                alert('题目数据格式错误');
                return;
            }
            
            var questionsList = document.getElementById('questionsList');
            if (!questionsList) {
                console.error('找不到 questionsList 元素');
                return;
            }
            
            questionsList.innerHTML = '';
            
            var questionCountEl = document.getElementById('questionCount');
            if (questionCountEl) {
                questionCountEl.textContent = questions.length;
            }
            
            if (questions.length === 0) {
                questionsList.innerHTML = '<p class="text-gray-500 text-center">暂无题目</p>';
                document.getElementById('questionsListCard').style.display = 'block';
                return;
            }
            
            // 定义不同颜色的卡片背景色数组（浅色背景，透明度适中）
            var cardBackgroundColors = [
                'rgba(59, 130, 246, 0.1)',   // 浅蓝色
                'rgba(16, 185, 129, 0.1)',   // 浅绿色
                'rgba(245, 158, 11, 0.1)',   // 浅橙色
                'rgba(239, 68, 68, 0.1)',    // 浅红色
                'rgba(139, 92, 246, 0.1)',   // 浅紫色
                'rgba(236, 72, 153, 0.1)',   // 浅粉色
                'rgba(6, 182, 212, 0.1)',    // 浅青色
                'rgba(132, 204, 22, 0.1)'    // 浅黄绿色
            ];
            
            questions.forEach(function(questionWithScore, index) {
                // 处理新的数据结构：questionWithScore.question 和 questionWithScore.lastScore
                var question = questionWithScore.question || questionWithScore; // 兼容旧格式
                
                if (!question || !question.id || !question.questionText) {
                    console.warn('题目数据不完整:', question);
                    return;
                }
                
                // 获取最近一次得分（默认为0）
                var score = 0;
                if (questionWithScore.lastScore !== undefined && questionWithScore.lastScore !== null) {
                    score = parseFloat(questionWithScore.lastScore) || 0;
                }
                
                // 选择卡片背景色（循环使用）
                var backgroundColor = cardBackgroundColors[index % cardBackgroundColors.length];
                
                // 创建题目卡片
                var questionCard = document.createElement('div');
                questionCard.className = 'border rounded-lg p-6 mb-6';
                questionCard.style.backgroundColor = backgroundColor;
                questionCard.style.borderColor = '#e0e0e0';
                questionCard.style.borderWidth = '1px';
                questionCard.style.borderRadius = '12px';
                questionCard.id = 'question-card-' + question.id;
                
                // 得分显示样式
                var scoreColor = '#666';
                if (score >= 80) {
                    scoreColor = '#10b981'; // 绿色
                } else if (score >= 60) {
                    scoreColor = '#3b82f6'; // 蓝色
                } else if (score >= 40) {
                    scoreColor = '#f59e0b'; // 橙色
                } else if (score > 0) {
                    scoreColor = '#ef4444'; // 红色
                }
                
                questionCard.innerHTML = 
                    '<div class="mb-4">' +
                        '<div class="flex items-center justify-between mb-2">' +
                            '<div class="font-semibold text-lg" style="color: #1a73e8;">题目 ' + (index + 1) + '</div>' +
                            '<div class="text-sm font-bold" style="color: ' + scoreColor + ';">' +
                                '最近得分: <span style="font-size: 1.1em;">' + score.toFixed(1) + '</span> 分' +
                            '</div>' +
                        '</div>' +
                        '<div class="bg-white p-4 rounded mb-4 border" style="border-radius: 8px; border-color: #e0e0e0;">' +
                            '<p style="color: #333; line-height: 1.6;">' + escapeHtml(question.questionText) + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mb-4">' +
                        '<label class="block text-sm font-bold mb-2" style="color: #333;">你的答案</label>' +
                        '<textarea id="answer-' + question.id + '" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" ' +
                              'rows="4" placeholder="请输入你的答案..." style="border-radius: 8px; color: #333; line-height: 1.6;"></textarea>' +
                    '</div>' +
                    '<button onclick="submitAnswerForQuestion(\'' + question.id + '\')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" style="border-radius: 8px;">' +
                        '提交答案' +
                    '</button>' +
                    '<div id="evaluation-' + question.id + '" class="mt-4" style="display: none;"></div>';
                
                questionsList.appendChild(questionCard);
            });
            
            document.getElementById('questionsListCard').style.display = 'block';
        }
        
        // HTML 转义函数（防止 XSS）
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 提交答案（针对特定题目）
        function submitAnswerForQuestion(questionId) {
            if (!requireLogin()) {
                return;
            }
            
            var answerTextEl = document.getElementById('answer-' + questionId);
            if (!answerTextEl) {
                alert('找不到答案输入框');
                return;
            }

            var answerText = answerTextEl.value.trim();
            if (!answerText) {
                alert('请输入答案');
                return;
            }

            // 禁用提交按钮，显示加载状态
            var submitBtn = answerTextEl.parentElement.nextElementSibling;
            var originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';

            fetch('/api/v1/learning/submit?userId=' + userId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'userId': userId
                },
                body: JSON.stringify({
                    userId: parseInt(userId),
                    questionId: questionId,
                    answerText: answerText
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                
                // 调试：打印接收到的数据
                console.log('提交答案响应:', JSON.stringify(data, null, 2));
                
                if (data.code === 200 && data.data) {
                    var result = data.data;
                    // 调试：打印解析后的结果
                    console.log('评价结果:', JSON.stringify(result, null, 2));
                    displayEvaluation(questionId, result);
                } else {
                    alert(data.message || '提交答案失败');
                }
            })
            .catch(function(error) {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                alert(error.message || '提交答案失败');
            });
        }

        // 显示评价结果
        function displayEvaluation(questionId, result) {
            var evaluationEl = document.getElementById('evaluation-' + questionId);
            if (!evaluationEl) {
                console.error('找不到评价元素: evaluation-' + questionId);
                return;
            }

            // 调试：打印结果对象
            console.log('displayEvaluation - result:', result);
            console.log('displayEvaluation - feedbackItems:', result.feedbackItems);
            console.log('displayEvaluation - recommendedAnswer:', result.recommendedAnswer);

            var score = result.score || 0;
            var scoreColor = score >= 80 ? 'text-green-600' : (score >= 60 ? 'text-yellow-600' : 'text-red-600');
            
            var html = '<div class="border-t pt-4 mt-4">' +
                '<h3 class="text-xl font-bold mb-4">评分结果</h3>' +
                '<div class="mb-4">' +
                    '<div class="text-3xl font-bold ' + scoreColor + ' mb-2">得分: ' + score.toFixed(1) + '分</div>' +
                '</div>';

            // 显示分析
            if (result.analysis) {
                html += '<div class="mb-4">' +
                    '<h4 class="text-lg font-semibold mb-2">详细分析</h4>' +
                    '<div class="bg-white p-4 rounded border whitespace-pre-wrap text-sm" style="border-color: #e0e0e0;">' + escapeHtml(result.analysis) + '</div>' +
                '</div>';
            }

            // 显示反馈项（feedbackItems）- 表格形式
            console.log('检查 feedbackItems:', result.feedbackItems, '类型:', typeof result.feedbackItems, '是数组:', Array.isArray(result.feedbackItems));
            if (result.feedbackItems && Array.isArray(result.feedbackItems) && result.feedbackItems.length > 0) {
                console.log('准备渲染 feedbackItems 表格，共', result.feedbackItems.length, '项');
                html += '<div class="mb-4">' +
                    '<h4 class="text-lg font-semibold mb-3">评分要点</h4>' +
                    '<div class="overflow-x-auto">' +
                        '<table class="min-w-full border-collapse border border-gray-300">' +
                            '<thead>' +
                                '<tr class="bg-gray-100">' +
                                    '<th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">状态</th>' +
                                    '<th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">评分标准</th>' +
                                    '<th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">你的回答</th>' +
                                '</tr>' +
                            '</thead>' +
                            '<tbody>';
                
                result.feedbackItems.forEach(function(item, index) {
                    // 确保 covered 是布尔值
                    var isCovered = item.covered === true || item.covered === 'true';
                    var coveredClass = isCovered ? 'bg-green-50' : 'bg-red-50';
                    var coveredIcon = isCovered ? 
                        '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-800">✓ 已覆盖</span>' : 
                        '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-red-100 text-red-800">✗ 未覆盖</span>';
                    
                    // 检查 userContent 是否为空（空字符串或 null/undefined）
                    var userContent = item.userContent;
                    var userContentDisplay = (userContent && userContent.trim().length > 0) ? 
                        escapeHtml(userContent) : 
                        '<span class="text-gray-400 italic">未提及</span>';
                    
                    html += '<tr class="' + coveredClass + '">' +
                        '<td class="border border-gray-300 px-4 py-3 align-top">' + coveredIcon + '</td>' +
                        '<td class="border border-gray-300 px-4 py-3 align-top text-sm text-gray-800">' + escapeHtml(item.criterion || '') + '</td>' +
                        '<td class="border border-gray-300 px-4 py-3 align-top text-sm text-gray-700">' + userContentDisplay + '</td>' +
                    '</tr>';
                });
                
                html += '</tbody>' +
                    '</table>' +
                    '</div>' +
                '</div>';
            }

            // 显示推荐答案 - 优化样式
            console.log('检查 recommendedAnswer:', result.recommendedAnswer, '类型:', typeof result.recommendedAnswer);
            if (result.recommendedAnswer && result.recommendedAnswer.trim().length > 0) {
                console.log('准备渲染推荐答案');
                // 处理 Markdown 格式的换行（\n 转换为 <br>）
                var recommendedAnswerText = escapeHtml(result.recommendedAnswer);
                // 将 \n 转换为 <br>，但保留原有的换行处理
                recommendedAnswerText = recommendedAnswerText.replace(/\n/g, '<br>');
                
                html += '<div class="mb-4">' +
                    '<h4 class="text-lg font-semibold mb-3 flex items-center">' +
                        '<svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
                        '</svg>' +
                        '推荐答案' +
                    '</h4>' +
                    '<div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-5 rounded-r-lg shadow-sm">' +
                        '<div class="text-sm text-gray-800 leading-relaxed">' + recommendedAnswerText + '</div>' +
                    '</div>' +
                '</div>';
            }

            html += '</div>';
            
            console.log('生成的 HTML 长度:', html.length);
            console.log('HTML 预览:', html.substring(0, 500));
            
            evaluationEl.innerHTML = html;
            evaluationEl.style.display = 'block';
            
            // 验证元素是否真的显示
            console.log('评价元素显示状态:', evaluationEl.style.display);
            console.log('评价元素内容长度:', evaluationEl.innerHTML.length);
            
            // 滚动到评价区域
            evaluationEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>
