<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习进度 - Quiz Me Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- 左侧：页面标题和导航 -->
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-gray-800">Quiz Me Up</h1>
                    <div class="flex space-x-2">
                        <a href="learning.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">学习</a>
                        <a href="progress.html" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-100 text-blue-700">进度</a>
                        <a id="adminLink" href="admin.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100" style="display: none;">管理</a>
                    </div>
                </div>
                
                <!-- 右侧：登录状态 -->
                <div class="flex items-center space-x-4">
                    <span id="userInfo" class="text-sm text-gray-600" style="display: none;"></span>
                    <button id="loginBtn" onclick="showLoginModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-700 text-white text-sm font-medium rounded-md focus:outline-none focus:shadow-outline">
                        登录
                    </button>
                    <button id="logoutBtn" onclick="handleLogout()" class="px-4 py-2 bg-gray-500 hover:bg-gray-700 text-white text-sm font-medium rounded-md focus:outline-none focus:shadow-outline" style="display: none;">
                        登出
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 登录模态框 -->
    <div id="loginModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">登录</h2>
                <button onclick="hideLoginModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="username">用户名</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                           id="username" type="text" placeholder="请输入用户名" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password">密码</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                           id="password" type="password" placeholder="请输入密码" required>
                </div>
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" 
                        type="submit">登录</button>
            </form>
        </div>
    </div>

    <div class="max-w-4xl mx-auto mt-10 p-6">
        <!-- 自动加载进度（如果已登录） -->
        <div id="autoLoadSection" style="display: none;"></div>

        <!-- 进度树 -->
        <div id="progressTree" class="bg-white rounded-lg shadow-md p-6">
            <p class="text-gray-500 text-center">请先登录以查看学习进度</p>
        </div>
    </div>

    <script>
        // 全局变量
        var userId = null;
        var username = null;

        // 页面加载时检查登录状态
        window.onload = function() {
            checkLoginStatus();
        };

        // 统一的登录检查函数
        function requireLogin() {
            if (!userId) {
                alert('请先登录');
                showLoginModal();
                return false;
            }
            return true;
        }

        // 检查登录状态
        function checkLoginStatus() {
            userId = sessionStorage.getItem('userId');
            username = sessionStorage.getItem('username');
            var userRole = sessionStorage.getItem('userRole');
            
            if (userId) {
                updateLoginUI(true);
                // 根据角色显示/隐藏管理页面链接
                var adminLink = document.getElementById('adminLink');
                if (adminLink) {
                    adminLink.style.display = (userRole === 'ADMIN') ? 'block' : 'none';
                }
                document.getElementById('autoLoadSection').style.display = 'block';
                loadProgress();
            } else {
                updateLoginUI(false);
                var adminLink = document.getElementById('adminLink');
                if (adminLink) {
                    adminLink.style.display = 'none';
                }
                document.getElementById('autoLoadSection').style.display = 'none';
                // 显示登录弹框
                showLoginModal();
                // 显示提示信息
                document.getElementById('progressTree').innerHTML = '<p class="text-yellow-800 text-center p-4 bg-yellow-50 border border-yellow-200 rounded">请先登录以查看学习进度</p>';
            }
        }

        // 更新登录UI
        function updateLoginUI(isLoggedIn) {
            var loginBtn = document.getElementById('loginBtn');
            var logoutBtn = document.getElementById('logoutBtn');
            var userInfo = document.getElementById('userInfo');
            
            if (isLoggedIn) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                userInfo.style.display = 'block';
                userInfo.textContent = '用户: ' + (username || 'User ' + userId);
            } else {
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                userInfo.style.display = 'none';
            }
        }

        // 显示登录模态框
        function showLoginModal() {
            var modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                console.error('loginModal 元素未找到');
            }
        }

        // 隐藏登录模态框
        function hideLoginModal() {
            var modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // 清空表单
            var form = document.getElementById('loginForm');
            if (form) {
                form.reset();
            }
        }

        // 登录处理
        function handleLogin(event) {
            event.preventDefault();
            var usernameInput = document.getElementById('username').value;
            var password = document.getElementById('password').value;

            fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: usernameInput,
                    password: password
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.code === 200 && data.data) {
                    userId = data.data.userId.toString();
                    username = data.data.username || usernameInput;
                    var userRole = data.data.role || null;
                    sessionStorage.setItem('userId', userId);
                    sessionStorage.setItem('username', username);
                    sessionStorage.setItem('userRole', userRole);
                    
                    hideLoginModal();
                    updateLoginUI(true);
                    // 根据角色显示/隐藏管理页面链接
                    var adminLink = document.getElementById('adminLink');
                    if (adminLink) {
                        adminLink.style.display = (userRole === 'ADMIN') ? 'block' : 'none';
                    }
                    document.getElementById('autoLoadSection').style.display = 'block';
                    loadProgress();
                } else {
                    alert(data.message || '登录失败');
                }
            })
            .catch(function(error) {
                alert(error.message || '登录失败，请重试');
            });
        }

        // 登出处理
        function handleLogout() {
            if (confirm('确定要登出吗？')) {
                sessionStorage.clear();
                // 重定向到登录页面
                window.location.href = 'login.html';
            }
        }

        // 加载进度树
        function loadProgress() {
            if (!requireLogin()) {
                return;
            }

            fetch('/api/v1/progress/tree?userId=' + userId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'userId': userId
                },
                body: JSON.stringify({
                    userId: parseInt(userId)
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.code === 200 && data.data) {
                    renderProgressTree(data.data);
                } else {
                    alert(data.message || '加载进度失败');
                }
            })
            .catch(function(error) {
                alert(error.message || '加载进度失败');
            });
        }

        // 渲染进度树
        function renderProgressTree(nodes) {
            var container = document.getElementById('progressTree');
            if (!nodes || nodes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">暂无进度数据</p>';
                return;
            }

            container.innerHTML = '';
            nodes.forEach(function(node) {
                var nodeElement = createNodeElement(node);
                container.appendChild(nodeElement);
            });
        }

        // 创建节点元素（递归）
        function createNodeElement(node) {
            var proficiency = node.proficiency ? parseFloat(node.proficiency) : 0;
            var proficiencyPercent = proficiency.toFixed(2) + '%';
            
            // 判断是否为叶子节点
            var isLeaf = node.isLeaf === true || !node.children || node.children.length === 0;
            
            if (isLeaf) {
                // 叶子节点：不使用 details/summary，直接使用 div，不显示小三角
                var leafDiv = document.createElement('div');
                leafDiv.className = 'mb-2 p-2';
                
                // 节点标题和掌握度
                var titleDiv = document.createElement('div');
                titleDiv.className = 'flex items-center justify-between';
                
                var nameSpan = document.createElement('span');
                nameSpan.textContent = node.name || node.id;
                nameSpan.className = 'mr-4 font-semibold';
                
                var proficiencySpan = document.createElement('span');
                proficiencySpan.textContent = proficiencyPercent;
                proficiencySpan.className = 'text-blue-600 font-bold mr-4';
                
                titleDiv.appendChild(nameSpan);
                titleDiv.appendChild(proficiencySpan);
                leafDiv.appendChild(titleDiv);
                
                // 进度条
                var progressBarContainer = document.createElement('div');
                progressBarContainer.className = 'w-full bg-gray-200 rounded-full h-2.5 mt-2';
                
                var progressBar = document.createElement('div');
                progressBar.className = 'bg-green-500 h-2.5 rounded-full';
                progressBar.style.width = proficiency + '%';
                
                progressBarContainer.appendChild(progressBar);
                leafDiv.appendChild(progressBarContainer);
                
                return leafDiv;
            } else {
                // 非叶子节点：使用 details/summary，可以展开/折叠
                var details = document.createElement('details');
                details.className = 'mb-2';
                
                var summary = document.createElement('summary');
                summary.className = 'cursor-pointer font-semibold p-2 hover:bg-gray-100 rounded';
                
                // 节点标题和掌握度
                var titleDiv = document.createElement('div');
                titleDiv.className = 'flex items-center justify-between';
                
                var nameSpan = document.createElement('span');
                nameSpan.textContent = node.name || node.id;
                nameSpan.className = 'mr-4';
                
                var proficiencySpan = document.createElement('span');
                proficiencySpan.textContent = proficiencyPercent;
                proficiencySpan.className = 'text-blue-600 font-bold mr-4';
                
                titleDiv.appendChild(nameSpan);
                titleDiv.appendChild(proficiencySpan);
                summary.appendChild(titleDiv);
                
                // 进度条
                var progressBarContainer = document.createElement('div');
                progressBarContainer.className = 'w-full bg-gray-200 rounded-full h-2.5 mt-2';
                
                var progressBar = document.createElement('div');
                progressBar.className = 'bg-green-500 h-2.5 rounded-full';
                progressBar.style.width = proficiency + '%';
                
                progressBarContainer.appendChild(progressBar);
                summary.appendChild(progressBarContainer);
                
                details.appendChild(summary);
                
                // 子节点
                var childrenDiv = document.createElement('div');
                childrenDiv.className = 'ml-4 mt-2';
                
                node.children.forEach(function(child) {
                    var childElement = createNodeElement(child);
                    childrenDiv.appendChild(childElement);
                });
                
                details.appendChild(childrenDiv);
                
                return details;
            }
        }

    </script>
</body>
</html>

