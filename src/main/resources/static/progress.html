<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIé¢è¯•æ¨¡æ‹Ÿ - å­¦ä¹ è¿›åº¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¡¨æ ¼æ ·å¼ */
        .knowledge-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .knowledge-table th {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-weight: 600;
            padding: 16px;
            text-align: left;
            border: none;
        }

        .knowledge-table th:first-child {
            border-top-left-radius: 12px;
        }

        .knowledge-table th:last-child {
            border-top-right-radius: 12px;
        }

        .knowledge-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
        }

        .knowledge-table tbody tr {
            transition: all 0.2s ease;
        }

        .knowledge-table tbody tr:hover {
            background-color: #f9fafb;
        }

        .knowledge-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        .knowledge-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }

        /* å±•å¼€/æŠ˜å æŒ‰é’® */
        .toggle-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #e5e7eb;
            color: #6b7280;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }

        .toggle-icon:hover {
            background: #3b82f6;
            color: white;
        }

        .toggle-icon.expanded {
            background: #3b82f6;
            color: white;
        }

        /* å­èŠ‚ç‚¹è¡Œ */
        .child-row {
            display: none;
        }

        .child-row.expanded {
            display: table-row;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç¼©è¿›æ ·å¼ */
        .indent-1 { padding-left: 40px !important; }
        .indent-2 { padding-left: 60px !important; }
        .indent-3 { padding-left: 80px !important; }

        /* çŸ¥è¯†ç‚¹åç§°æ ·å¼ */
        .knowledge-name {
            font-weight: 500;
            color: #1f2937;
        }

        .knowledge-name.root {
            font-weight: 600;
            font-size: 1.05rem;
            color: #1e40af;
        }

        /* æŒæ¡åº¦è¿›åº¦æ¡ */
        .mastery-progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mastery-progress-bar {
            flex: 1;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .mastery-progress-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
        }

        .mastery-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* æŒæ¡åº¦å¾½ç«  */
        .mastery-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        /* æŒæ¡åº¦åˆ†æ•° */
        .mastery-score {
            font-size: 1.25rem;
            font-weight: 700;
            min-width: 50px;
            text-align: right;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-xl">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">ğŸ“Š AIé¢è¯•æ¨¡æ‹Ÿå¹³å°</h1>
                <div class="space-x-4">
                    <a href="/interview.html" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition-colors backdrop-blur-sm">ç­”é¢˜</a>
                    <a href="/progress.html" class="px-4 py-2 bg-white/30 rounded-lg hover:bg-white/40 transition-colors backdrop-blur-sm font-semibold">è¿›åº¦</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 mb-6 border border-white/20">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div>
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                        ğŸ“‹ çŸ¥è¯†ç‚¹æŒæ¡åº¦è¡¨æ ¼
                    </h2>
                    <p class="text-gray-600 mt-1">æŸ¥çœ‹ä½ çš„å­¦ä¹ è¿›åº¦å’ŒçŸ¥è¯†æŒæ¡æƒ…å†µ</p>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="text-gray-700 font-medium">ç”¨æˆ·IDï¼š</label>
                    <input 
                        type="number" 
                        id="userIdInput" 
                        value="1" 
                        min="1"
                        class="w-24 px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                    />
                    <button 
                        onclick="loadKnowledgeTree()" 
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105 font-semibold">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- è¡¨æ ¼å®¹å™¨ -->
        <div id="tableContainer" class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 border border-white/20 overflow-hidden">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“Š</div>
                <p class="text-xl">ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®åŠ è½½çŸ¥è¯†ç‚¹æ•°æ®</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        const TOKEN = 'local-dev-token';

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½
        window.addEventListener('DOMContentLoaded', () => {
            loadKnowledgeTree();
        });

        // åŠ è½½çŸ¥è¯†ç‚¹æ ‘
        async function loadKnowledgeTree() {
            const userId = document.getElementById('userIdInput').value;
            if (!userId || userId < 1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·ID');
                return;
            }

            const container = document.getElementById('tableContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600 mb-4"></div>
                    <p class="text-gray-600 text-lg">åŠ è½½ä¸­...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/api/interview/knowledge-tree?userId=${userId}`, {
                    headers: {
                        'X-Token': TOKEN
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'è·å–çŸ¥è¯†ç‚¹æ ‘å¤±è´¥');
                }

                const tree = await response.json();
                displayTable(tree);
            } catch (error) {
                console.error('åŠ è½½çŸ¥è¯†ç‚¹æ ‘å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <p class="text-red-600 text-xl">åŠ è½½å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }

        // å­˜å‚¨èŠ‚ç‚¹æ•°æ®ç”¨äºå±•å¼€/æŠ˜å 
        let nodeMap = new Map();

        // æ˜¾ç¤ºè¡¨æ ¼
        function displayTable(tree) {
            const container = document.getElementById('tableContainer');
            nodeMap.clear();
            
            if (!tree || tree.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p class="text-gray-600 text-xl">æš‚æ— çŸ¥è¯†ç‚¹æ•°æ®</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="overflow-x-auto">
                    <table class="knowledge-table">
                        <thead>
                            <tr>
                                <th style="width: 40%">çŸ¥è¯†ç‚¹åç§°</th>
                                <th style="width: 15%">æŒæ¡åº¦åˆ†æ•°</th>
                                <th style="width: 30%">æŒæ¡åº¦è¿›åº¦</th>
                                <th style="width: 15%">æŒæ¡çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // é€’å½’æ¸²æŸ“èŠ‚ç‚¹
            tree.forEach((node, index) => {
                html += renderTableRow(node, 0, index, '');
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ¸²æŸ“è¡¨æ ¼è¡Œ
        function renderTableRow(node, level, index, parentPath) {
            const hasChildren = node.children && node.children.length > 0;
            const nodeId = node.id;
            const rowId = `row-${nodeId}`;
            const mastery = node.mastery || 0;
            const masteryConfig = getMasteryConfig(mastery);
            const indentClass = level > 0 ? `indent-${Math.min(level, 3)}` : '';
            const isRoot = level === 0;

            // å­˜å‚¨èŠ‚ç‚¹ä¿¡æ¯
            nodeMap.set(nodeId, {
                id: nodeId,
                children: node.children || [],
                level: level
            });

            let html = `
                <tr class="${isRoot ? 'root-row' : 'child-row'}" id="${rowId}" data-node-id="${nodeId}" data-level="${level}" data-parent-id="${node.parentId || ''}" style="display: ${level === 0 ? 'table-row' : 'none'}">
                    <td class="${indentClass}">
                        <div class="flex items-center">
                            ${hasChildren ? `
                                <span class="toggle-icon" onclick="toggleRow(${nodeId})" id="icon-${nodeId}">â–¶</span>
                            ` : '<span class="toggle-icon" style="visibility: hidden;">â–¶</span>'}
                            <span class="knowledge-name ${isRoot ? 'root' : ''}">${escapeHtml(node.name)}</span>
                        </div>
                    </td>
                    <td>
                        <span class="mastery-score ${masteryConfig.textColor}">${mastery}</span>
                        <span class="text-gray-500 text-sm">/ 100</span>
                    </td>
                    <td>
                        <div class="mastery-progress-container">
                            <div class="mastery-progress-bar">
                                <div class="mastery-progress-fill ${masteryConfig.progressClass}" 
                                     style="width: ${mastery}%">
                                    ${mastery > 10 ? mastery + '%' : ''}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="mastery-badge ${masteryConfig.badgeClass}">
                            ${masteryConfig.label}
                        </span>
                    </td>
                </tr>
            `;

            // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
            if (hasChildren) {
                node.children.forEach((child, idx) => {
                    html += renderTableRow(child, level + 1, idx, parentPath + '-' + nodeId);
                });
            }

            return html;
        }

        // åˆ‡æ¢è¡Œå±•å¼€/æ”¶èµ·
        function toggleRow(nodeId) {
            const icon = document.getElementById(`icon-${nodeId}`);
            const nodeInfo = nodeMap.get(nodeId);
            
            if (!icon || !nodeInfo) return;

            const isExpanded = icon.classList.contains('expanded');

            if (isExpanded) {
                // æ”¶èµ·ï¼šéšè—æ‰€æœ‰å­èŠ‚ç‚¹
                icon.classList.remove('expanded');
                icon.textContent = 'â–¶';
                hideChildren(nodeId);
            } else {
                // å±•å¼€ï¼šæ˜¾ç¤ºç›´æ¥å­èŠ‚ç‚¹
                icon.classList.add('expanded');
                icon.textContent = 'â–¼';
                showChildren(nodeId);
            }
        }

        // æ˜¾ç¤ºå­èŠ‚ç‚¹
        function showChildren(parentId) {
            const nodeInfo = nodeMap.get(parentId);
            if (!nodeInfo || !nodeInfo.children) return;

            nodeInfo.children.forEach(child => {
                const row = document.getElementById(`row-${child.id}`);
                if (row) {
                    row.style.display = 'table-row';
                    row.classList.add('expanded');
                }
            });
        }

        // éšè—å­èŠ‚ç‚¹ï¼ˆé€’å½’ï¼‰
        function hideChildren(parentId) {
            const nodeInfo = nodeMap.get(parentId);
            if (!nodeInfo || !nodeInfo.children) return;

            nodeInfo.children.forEach(child => {
                const row = document.getElementById(`row-${child.id}`);
                const icon = document.getElementById(`icon-${child.id}`);
                
                if (row) {
                    row.style.display = 'none';
                    row.classList.remove('expanded');
                }
                
                // å¦‚æœå­èŠ‚ç‚¹æ˜¯å±•å¼€çš„ï¼Œå…ˆæ”¶èµ·å®ƒçš„å›¾æ ‡
                if (icon && icon.classList.contains('expanded')) {
                    icon.classList.remove('expanded');
                    icon.textContent = 'â–¶';
                }
                
                // é€’å½’éšè—å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
                hideChildren(child.id);
            });
        }

        // è·å–æŒæ¡åº¦é…ç½®
        function getMasteryConfig(mastery) {
            if (mastery >= 90) {
                return {
                    label: 'å“è¶Š',
                    badgeClass: 'bg-green-500 text-white',
                    progressClass: 'bg-gradient-to-r from-green-400 to-green-600',
                    textColor: 'text-green-600'
                };
            } else if (mastery >= 80) {
                return {
                    label: 'ä¼˜ç§€',
                    badgeClass: 'bg-green-400 text-white',
                    progressClass: 'bg-gradient-to-r from-green-300 to-green-500',
                    textColor: 'text-green-600'
                };
            } else if (mastery >= 70) {
                return {
                    label: 'è‰¯å¥½',
                    badgeClass: 'bg-blue-400 text-white',
                    progressClass: 'bg-gradient-to-r from-blue-300 to-blue-500',
                    textColor: 'text-blue-600'
                };
            } else if (mastery >= 60) {
                return {
                    label: 'åŠæ ¼',
                    badgeClass: 'bg-yellow-400 text-white',
                    progressClass: 'bg-gradient-to-r from-yellow-300 to-yellow-500',
                    textColor: 'text-yellow-600'
                };
            } else if (mastery >= 40) {
                return {
                    label: 'ä¸€èˆ¬',
                    badgeClass: 'bg-orange-400 text-white',
                    progressClass: 'bg-gradient-to-r from-orange-300 to-orange-500',
                    textColor: 'text-orange-600'
                };
            } else {
                return {
                    label: 'éœ€åŠ å¼º',
                    badgeClass: 'bg-red-400 text-white',
                    progressClass: 'bg-gradient-to-r from-red-300 to-red-500',
                    textColor: 'text-red-600'
                };
            }
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
